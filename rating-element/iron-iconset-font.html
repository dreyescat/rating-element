<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-meta/iron-meta.html">
<script>
  /**
   * The `iron-iconset-font` element allows users to define their own icon sets
   * that contain font icons. The font icon elements should be children of the
   * `iron-iconset-font` element. Multiple icons should be given distinct id's.
   *
   * Example:
   *
   *     <iron-iconset-font name="my-font-icons" size="24">
   *       <span id="shape" class="fa fa-star"></span>
   *     </iron-iconset-svg>
   *
   * This will automatically register the icon set "my-font-icons" to the 
   * iconset database. To use these icons from within another element, make a
   * `iron-iconset` element and call the `byId` method
   * to retrieve a given iconset. To apply a particular icon inside an
   * element use the `applyIcon` method. For example:
   *
   *     iconset.applyIcon(iconNode, 'car');
   *
   * @element iron-iconset-font
   * @demo demo/index.html
   */
  Polymer({

    is: 'iron-iconset-font',

    properties: {

      /**
       * The name of the iconset.
       *
       * @attribute name
       * @type string
       */
      name: {
        type: String,
        observer: '_nameChanged'
      },

      /**
       * The size of an individual icon. Note that icons must be square.
       *
       * @attribute iconSize
       * @type number
       * @default 24
       */
      size: {
        type: Number,
        value: 24
      }

    },

    /**
     * Construct an array of all icon names in this iconset.
     *
     * @return {!Array} Array of icon names.
     */
    getIconNames: function() {
      this._icons = this._createIconMap();
      return Object.keys(this._icons).map(function(n) {
        return this.name + ':' + n;
      }, this);
    },

    /**
     * Applies an icon to the given element.
     *
     * An font icon is prepended to the element's shadowRoot if it exists,
     * otherwise to the element itself.
     *
     * @method applyIcon
     * @param {Element} element Element to which the icon is applied.
     * @param {string} iconName Name of the icon to apply.
     * @return {Element} The font element which renders the icon.
     */
    applyIcon: function(element, iconName) {
      // insert font element into shadow root, if it exists
      element = element.root || element;

      this.removeIcon(element);
      var font = this._cloneIcon(iconName);
      if (font) {
        var pde = Polymer.dom(element);
        pde.insertBefore(font, pde.childNodes[0]);
        return element._fontIcon = font;
      }

      return null;
    },

    /**
     * Remove an icon from the given element by undoing the changes effected
     * by `applyIcon`.
     *
     * @param {Element} element The element from which the icon is removed.
     */
    removeIcon: function(element) {
      // Remove old font element
      if (element._fontIcon) {
        Polymer.dom(element).removeChild(element._fontIcon);
        element._fontIcon = null;
      }
    },

    /**
     *
     * When name is changed, register iconset metadata
     *
     */
    _nameChanged: function() {
      new Polymer.IronMeta({type: 'iconset', key: this.name, value: this});
    },

    /**
     * Create a map of child font icon elements by id.
     *
     * @return {!Object} Map of id's to font icon elements.
     */
    _createIconMap: function() {
      // Objects chained to Object.prototype (`{}`) have members. Specifically,
      // on FF there is a `watch` method that confuses the icon map, so we
      // need to use a null-based object here.
      var icons = Object.create(null);
      Polymer.dom(this).querySelectorAll('[id]')
        .forEach(function(icon) {
          icons[icon.id] = icon;
        });
      return icons;
    },

    /**
     * Produce installable clone of the font icon element matching `id` in this
     * iconset, or `undefined` if there is no matching element.
     *
     * @return {Element} Returns an installable clone of the font icon element
     * matching `id`.
     */
    _cloneIcon: function(id) {
      // create the icon map on-demand, since the iconset itself has no discrete
      // signal to know when it's children are fully parsed
      this._icons = this._icons || this._createIconMap();
      return this._prepareClone(this._icons[id], this.size);
    },

    /**
     * @param {Element} sourceFont
     * @param {number} size
     * @return {Element}
     */
    _prepareClone: function(source, size) {
      if (source) {
        var font = source.cloneNode(true);
        if (size !== undefined) {
          font.style.fontSize = size + 'px';
        }
        return font;
      }
      return null;
    }

  });
</script>
